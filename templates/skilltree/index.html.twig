<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>Skill Tree â€“ {{ skilltreeName }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
    <h1 class="text-center text-xl font-bold my-4">{{ skilltreeName }}</h1>

    <div id="graph" class="relative mx-auto p-4 bg-white">
        <svg id="edges" class="absolute inset-0 pointer-events-none z-0"></svg>
        <div id="node-grid" class="grid grid-cols-4 grid-rows-5 auto-rows-min gap-4">
            {% for n in nodes %}
                <div
                class="bg-white border-2 border-gray-800 rounded p-2 text-center text-xs z-10"
                style="grid-row-start: {{ n.x }}; grid-column-start: {{ n.y }};"
                data-name="{{ n.name }}"
                data-edges="{{ n.edges|join(',') }}"
                >
                    <img src="{{ n.coverUrl }}" alt="" class="mx-auto mb-1 w-12 h-12 object-cover rounded"/>
                    <strong class="block mb-1">{{ n.name }}</strong>
                    <p class="text-[10px] mb-1">{{ n.type }} &middot; {{ n.cost }} PC</p>
                    {% if n.description %}
                        <p class="text-[9px] text-gray-600">{{ n.description }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    {# Pass the node list into JS for edge-drawing #}
    <script>
        const nodes = [
            {% for n in nodes %}
                {
                    name: "{{ n.name|e('js') }}",
                    edges: [{% for e in n.edges %}"{{ e|e('js') }}"{% if not loop.last %}, {% endif %}{% endfor %}],
                }
                {% if not loop.last %}, {% endif %}
            {% endfor %}
        ];

        const graph = document.getElementById('graph');
        const grid = document.getElementById('node-grid');
        const svg = document.getElementById('edges');
        const elementMap = {};

        function computeCenters() {
            const bounds = graph.getBoundingClientRect();

            return Array.from(grid.children).reduce((map, el) => {
                const name = el.getAttribute('data-name');
                const r    = el.getBoundingClientRect();
                map[name]   = {
                x: r.left + r.width/2 - bounds.left,
                y: r.top  + r.height/2 - bounds.top,
                };
                return map;
            }, {});
        }

        function renderEdges() {
            const bounds  = graph.getBoundingClientRect();
            svg.setAttribute('width',  bounds.width);
            svg.setAttribute('height', bounds.height);
            svg.innerHTML = '';

            const centers = computeCenters();
            nodes.forEach(n => {
                const from = centers[n.name];
                n.edges.forEach(targetName => {
                    const to = centers[targetName];
                    if (!from || !to) return;

                    const line = document.createElementNS(svg.namespaceURI, 'line');
                    line.setAttribute('x1', from.x);
                    line.setAttribute('y1', from.y);
                    line.setAttribute('x2', to.x);
                    line.setAttribute('y2', to.y);
                    line.setAttribute('stroke', '#333');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                });
            });
        }

        window.addEventListener('load',  () => requestAnimationFrame(renderEdges));
        window.addEventListener('resize', () => requestAnimationFrame(renderEdges));
    </script>
</body>
</html>
